<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centipede - Classic Arcade Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            background: #000;
            border: 4px solid #0f0;
            box-shadow: 0 0 20px #0f0, inset 0 0 20px #0f0;
        }

        #gameCanvas {
            display: block;
            background: #000;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px #0f0;
            z-index: 10;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f00;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 0 0 20px #f00, 0 0 40px #f00;
            display: none;
            z-index: 20;
            text-align: center;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #0f0;
            font-size: 24px;
            text-align: center;
            z-index: 20;
            text-shadow: 0 0 10px #0f0;
        }

        #startScreen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ff0;
            text-shadow: 0 0 20px #ff0;
        }

        #startScreen p {
            margin: 10px 0;
            color: #0ff;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div>SCORE: <span id="score">0</span></div>
            <div>LIVES: <span id="lives">3</span></div>
            <div>WAVE: <span id="wave">1</span></div>
            <div>NEXT LIFE: <span id="nextLife">12000</span></div>
        </div>
        <div id="gameOver">
            GAME OVER<br>
            <span style="font-size: 24px;">Press SPACE to restart</span>
        </div>
        <div id="startScreen">
            <h1>CENTIPEDE</h1>
            <p>Use ARROW KEYS to move</p>
            <p>Press SPACEBAR to shoot</p>
            <p>Press SPACE to start</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ui = {
            score: document.getElementById('score'),
            lives: document.getElementById('lives'),
            wave: document.getElementById('wave'),
            nextLife: document.getElementById('nextLife'),
            gameOver: document.getElementById('gameOver'),
            startScreen: document.getElementById('startScreen')
        };

        // Set canvas size
        canvas.width = 800;
        canvas.height = 600;
        const GRID_SIZE = 20;
        const COLS = Math.floor(canvas.width / GRID_SIZE);
        const ROWS = Math.floor(canvas.height / GRID_SIZE);

        // Game state
        let gameState = 'start'; // 'start', 'playing', 'gameOver'
        let score = 0;
        let lives = 3;
        let wave = 1;
        let nextLifeScore = 12000;
        let frameCount = 0;

        // Player
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 40,
            width: 20,
            height: 20,
            speed: 4,
            color: '#0ff'
        };

        // Bullets
        const bullets = [];

        // Centipedes
        const centipedes = [];

        // Mushrooms
        const mushrooms = [];

        // Enemies
        const fleas = [];
        const spiders = [];
        const scorpions = [];

        // Particles for effects
        const particles = [];

        // Audio context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Sound effects
        function playSound(frequency, duration, type = 'sine', volume = 0.3) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Create initial mushrooms
        function createInitialMushrooms() {
            mushrooms.length = 0;
            for (let i = 0; i < 20 + wave * 5; i++) {
                const x = Math.floor(Math.random() * COLS) * GRID_SIZE;
                const y = Math.floor(Math.random() * (ROWS - 4)) * GRID_SIZE;
                if (y < canvas.height - 100) {
                    mushrooms.push({
                        x: x,
                        y: y,
                        hits: 0,
                        maxHits: 4,
                        poisoned: false,
                        color: '#0f0'
                    });
                }
            }
        }

        // Create centipede
        function createCentipede() {
            const segments = 10 + Math.floor(wave / 2);
            const centipede = {
                segments: [],
                direction: 1, // 1 = right, -1 = left
                movingDown: false,
                speed: 1 + wave * 0.2
            };

            for (let i = 0; i < segments; i++) {
                centipede.segments.push({
                    x: i * GRID_SIZE,
                    y: 0,
                    isHead: i === 0,
                    destroyed: false
                });
            }

            centipedes.push(centipede);
        }

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'Space') {
                e.preventDefault();
                if (gameState === 'start') {
                    gameState = 'playing';
                    ui.startScreen.style.display = 'none';
                    startGame();
                } else if (gameState === 'gameOver') {
                    resetGame();
                } else if (gameState === 'playing') {
                    shoot();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Player movement
        function updatePlayer() {
            if (keys['ArrowLeft'] && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            if (keys['ArrowUp'] && player.y > canvas.height - 150) {
                player.y -= player.speed;
            }
            if (keys['ArrowDown'] && player.y < canvas.height - 40) {
                player.y += player.speed;
            }
        }

        // Shooting
        function shoot() {
            bullets.push({
                x: player.x + player.width / 2,
                y: player.y,
                speed: 8,
                width: 4,
                height: 10
            });
            playSound(800, 0.1, 'square', 0.2);
        }

        // Update bullets
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed;
                if (bullets[i].y < 0) {
                    bullets.splice(i, 1);
                }
            }
        }

        // Update centipedes
        function updateCentipedes() {
            for (let c = centipedes.length - 1; c >= 0; c--) {
                const centipede = centipedes[c];
                if (centipede.segments.length === 0) {
                    centipedes.splice(c, 1);
                    continue;
                }

                const head = centipede.segments[0];
                if (!head || head.destroyed) continue;

                let newX = head.x + centipede.direction * centipede.speed;
                let newY = head.y;

                // Check boundaries
                if (newX < 0 || newX >= canvas.width - GRID_SIZE) {
                    centipede.direction *= -1;
                    newY += GRID_SIZE;
                    centipede.movingDown = true;
                } else {
                    centipede.movingDown = false;
                }

                // Check mushroom collision
                const gridX = Math.floor(newX / GRID_SIZE) * GRID_SIZE;
                const gridY = Math.floor(newY / GRID_SIZE) * GRID_SIZE;
                
                let hitMushroom = false;
                for (const mushroom of mushrooms) {
                    const mGridX = Math.floor(mushroom.x / GRID_SIZE) * GRID_SIZE;
                    const mGridY = Math.floor(mushroom.y / GRID_SIZE) * GRID_SIZE;
                    if (gridX === mGridX && gridY === mGridY) {
                        centipede.direction *= -1;
                        newY += GRID_SIZE;
                        hitMushroom = true;
                        break;
                    }
                }

                // Update head position
                head.x = newX;
                head.y = newY;

                // Update body segments following head
                for (let i = 1; i < centipede.segments.length; i++) {
                    const seg = centipede.segments[i];
                    if (seg.destroyed) continue;
                    
                    const prevSeg = centipede.segments[i - 1];
                    if (prevSeg && !prevSeg.destroyed) {
                        const dx = prevSeg.x - seg.x;
                        const dy = prevSeg.y - seg.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > GRID_SIZE * 1.5) {
                            seg.x = prevSeg.x;
                            seg.y = prevSeg.y;
                        } else if (dist > GRID_SIZE) {
                            seg.x += (dx / dist) * centipede.speed;
                            seg.y += (dy / dist) * centipede.speed;
                        }
                    }
                }

                // Check if centipede reached bottom
                if (head.y >= canvas.height - 50) {
                    playerHit();
                }
            }
        }

        // Update mushrooms
        function updateMushrooms() {
            // Mushrooms don't move, just update visual state
        }

        // Update fleas
        function updateFleas() {
            if (frameCount % (300 - wave * 20) === 0 && Math.random() < 0.3) {
                fleas.push({
                    x: Math.random() * canvas.width,
                    y: 0,
                    speed: 2 + wave * 0.3,
                    width: 16,
                    height: 16
                });
            }

            for (let i = fleas.length - 1; i >= 0; i--) {
                const flea = fleas[i];
                flea.y += flea.speed;
                
                if (flea.y > canvas.height) {
                    // Drop mushroom
                    const gridX = Math.floor(flea.x / GRID_SIZE) * GRID_SIZE;
                    const gridY = Math.floor(flea.y / GRID_SIZE) * GRID_SIZE;
                    mushrooms.push({
                        x: gridX,
                        y: gridY,
                        hits: 0,
                        maxHits: 4,
                        poisoned: false,
                        color: '#0f0'
                    });
                    fleas.splice(i, 1);
                }
            }
        }

        // Update spiders
        function updateSpiders() {
            if (frameCount % (400 - wave * 25) === 0 && Math.random() < 0.25) {
                spiders.push({
                    x: Math.random() < 0.5 ? 0 : canvas.width,
                    y: canvas.height - 100,
                    speedX: (Math.random() < 0.5 ? 1 : -1) * (2 + wave * 0.2),
                    speedY: (Math.random() < 0.5 ? 1 : -1) * (2 + wave * 0.2),
                    width: 20,
                    height: 20,
                    angle: Math.random() * Math.PI * 2
                });
            }

            for (let i = spiders.length - 1; i >= 0; i--) {
                const spider = spiders[i];
                spider.angle += 0.1;
                spider.x += spider.speedX * Math.cos(spider.angle);
                spider.y += spider.speedY * Math.sin(spider.angle);
                
                if (spider.x < 0 || spider.x > canvas.width || 
                    spider.y < 0 || spider.y > canvas.height) {
                    spiders.splice(i, 1);
                }
            }
        }

        // Update scorpions
        function updateScorpions() {
            if (frameCount % (500 - wave * 30) === 0 && Math.random() < 0.2) {
                scorpions.push({
                    x: 0,
                    y: Math.random() * (canvas.height - 200),
                    speed: 3 + wave * 0.3,
                    width: 20,
                    height: 16
                });
            }

            for (let i = scorpions.length - 1; i >= 0; i--) {
                const scorpion = scorpions[i];
                scorpion.x += scorpion.speed;
                
                if (scorpion.x > canvas.width) {
                    scorpions.splice(i, 1);
                }
            }
        }

        // Collision detection
        function checkCollisions() {
            // Bullet vs Centipede
            for (let b = bullets.length - 1; b >= 0; b--) {
                const bullet = bullets[b];
                
                for (let c = centipedes.length - 1; c >= 0; c--) {
                    const centipede = centipedes[c];
                    
                    for (let s = centipede.segments.length - 1; s >= 0; s--) {
                        const segment = centipede.segments[s];
                        if (segment.destroyed) continue;
                        
                        if (bullet.x >= segment.x && bullet.x <= segment.x + GRID_SIZE &&
                            bullet.y >= segment.y && bullet.y <= segment.y + GRID_SIZE) {
                            
                            // Hit segment
                            segment.destroyed = true;
                            bullets.splice(b, 1);
                            
                            // Create explosion particles
                            createExplosion(segment.x + GRID_SIZE / 2, segment.y + GRID_SIZE / 2, '#ff0');
                            
                            // Score points
                            if (segment.isHead) {
                                score += 100;
                                playSound(600, 0.15, 'square', 0.3);
                            } else {
                                score += 10;
                                playSound(400, 0.1, 'square', 0.2);
                            }
                            
                            // Split centipede if middle segment hit
                            if (!segment.isHead && s > 0 && s < centipede.segments.length - 1) {
                                const newCentipede = {
                                    segments: centipede.segments.slice(s + 1),
                                    direction: centipede.direction,
                                    movingDown: false,
                                    speed: centipede.speed
                                };
                                centipede.segments = centipede.segments.slice(0, s);
                                if (newCentipede.segments.length > 0) {
                                    newCentipede.segments[0].isHead = true;
                                    centipedes.push(newCentipede);
                                }
                            }
                            
                            break;
                        }
                    }
                }
                
                // Bullet vs Mushroom
                for (let m = mushrooms.length - 1; m >= 0; m--) {
                    const mushroom = mushrooms[m];
                    if (bullet.x >= mushroom.x && bullet.x <= mushroom.x + GRID_SIZE &&
                        bullet.y >= mushroom.y && bullet.y <= mushroom.y + GRID_SIZE) {
                        
                        mushroom.hits++;
                        bullets.splice(b, 1);
                        createExplosion(mushroom.x + GRID_SIZE / 2, mushroom.y + GRID_SIZE / 2, '#0f0');
                        playSound(300, 0.1, 'sawtooth', 0.15);
                        
                        if (mushroom.hits >= mushroom.maxHits) {
                            mushrooms.splice(m, 1);
                            score += 1;
                            createExplosion(mushroom.x + GRID_SIZE / 2, mushroom.y + GRID_SIZE / 2, '#f00');
                            playSound(200, 0.2, 'square', 0.25);
                        }
                        break;
                    }
                }
                
                // Bullet vs Flea
                for (let f = fleas.length - 1; f >= 0; f--) {
                    const flea = fleas[f];
                    if (bullet.x >= flea.x && bullet.x <= flea.x + flea.width &&
                        bullet.y >= flea.y && bullet.y <= flea.y + flea.height) {
                        
                        fleas.splice(f, 1);
                        bullets.splice(b, 1);
                        score += 200;
                        createExplosion(flea.x + flea.width / 2, flea.y + flea.height / 2, '#f0f');
                        playSound(500, 0.15, 'square', 0.3);
                        break;
                    }
                }
                
                // Bullet vs Spider
                for (let s = spiders.length - 1; s >= 0; s--) {
                    const spider = spiders[s];
                    if (bullet.x >= spider.x && bullet.x <= spider.x + spider.width &&
                        bullet.y >= spider.y && bullet.y <= spider.y + spider.height) {
                        
                        spiders.splice(s, 1);
                        bullets.splice(b, 1);
                        score += 300;
                        createExplosion(spider.x + spider.width / 2, spider.y + spider.height / 2, '#0ff');
                        playSound(700, 0.2, 'square', 0.4);
                        break;
                    }
                }
                
                // Bullet vs Scorpion
                for (let sc = scorpions.length - 1; sc >= 0; sc--) {
                    const scorpion = scorpions[sc];
                    if (bullet.x >= scorpion.x && bullet.x <= scorpion.x + scorpion.width &&
                        bullet.y >= scorpion.y && bullet.y <= scorpion.y + scorpion.height) {
                        
                        scorpions.splice(sc, 1);
                        bullets.splice(b, 1);
                        score += 1000;
                        createExplosion(scorpion.x + scorpion.width / 2, scorpion.y + scorpion.height / 2, '#ff0');
                        playSound(900, 0.25, 'square', 0.5);
                        
                        // Poison mushrooms
                        for (const mushroom of mushrooms) {
                            if (Math.abs(mushroom.x - scorpion.x) < 200) {
                                mushroom.poisoned = true;
                                mushroom.color = '#ff0';
                            }
                        }
                        break;
                    }
                }
            }
            
            // Centipede vs Player
            for (const centipede of centipedes) {
                for (const segment of centipede.segments) {
                    if (segment.destroyed) continue;
                    if (player.x < segment.x + GRID_SIZE && player.x + player.width > segment.x &&
                        player.y < segment.y + GRID_SIZE && player.y + player.height > segment.y) {
                        playerHit();
                        return;
                    }
                }
            }
            
            // Spider vs Player
            for (const spider of spiders) {
                if (player.x < spider.x + spider.width && player.x + player.width > spider.x &&
                    player.y < spider.y + spider.height && player.y + player.height > spider.y) {
                    playerHit();
                    return;
                }
            }
        }

        // Create explosion particles
        function createExplosion(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    life: 30,
                    maxLife: 30,
                    color: color,
                    size: Math.random() * 4 + 2
                });
            }
        }

        // Update particles
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        // Player hit
        function playerHit() {
            lives--;
            playSound(150, 0.3, 'sawtooth', 0.5);
            createExplosion(player.x + player.width / 2, player.y + player.height / 2, '#f00');
            
            if (lives <= 0) {
                gameState = 'gameOver';
                ui.gameOver.style.display = 'block';
            } else {
                // Reset player position
                player.x = canvas.width / 2;
                player.y = canvas.height - 40;
            }
        }

        // Update UI
        function updateUI() {
            ui.score.textContent = score;
            ui.lives.textContent = lives;
            ui.wave.textContent = wave;
            ui.nextLife.textContent = nextLifeScore;
            
            // Check for extra life
            if (score >= nextLifeScore) {
                lives++;
                nextLifeScore += 12000;
                playSound(1000, 0.5, 'sine', 0.6);
            }
        }

        // Check wave completion
        function checkWaveComplete() {
            if (centipedes.length === 0 && frameCount % 60 === 0) {
                wave++;
                nextWave();
            }
        }

        // Next wave
        function nextWave() {
            createInitialMushrooms();
            createCentipede();
            if (wave > 2) {
                createCentipede();
            }
            playSound(800, 0.3, 'sine', 0.4);
        }

        // Reset game
        function resetGame() {
            gameState = 'playing';
            score = 0;
            lives = 3;
            wave = 1;
            nextLifeScore = 12000;
            frameCount = 0;
            bullets.length = 0;
            centipedes.length = 0;
            mushrooms.length = 0;
            fleas.length = 0;
            spiders.length = 0;
            scorpions.length = 0;
            particles.length = 0;
            player.x = canvas.width / 2;
            player.y = canvas.height - 40;
            ui.gameOver.style.display = 'none';
            startGame();
        }

        // Start game
        function startGame() {
            createInitialMushrooms();
            createCentipede();
        }

        // Draw functions
        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Draw gun barrel
            ctx.fillStyle = '#fff';
            ctx.fillRect(player.x + player.width / 2 - 2, player.y - 8, 4, 8);
            ctx.shadowBlur = 0;
        }

        function drawBullets() {
            ctx.fillStyle = '#fff';
            for (const bullet of bullets) {
                ctx.fillRect(bullet.x - bullet.width / 2, bullet.y, bullet.width, bullet.height);
            }
        }

        function drawCentipedes() {
            for (const centipede of centipedes) {
                for (let i = 0; i < centipede.segments.length; i++) {
                    const segment = centipede.segments[i];
                    if (segment.destroyed) continue;
                    
                    if (segment.isHead) {
                        ctx.fillStyle = '#ff0';
                        ctx.shadowBlur = 15;
                        ctx.shadowColor = '#ff0';
                    } else {
                        ctx.fillStyle = '#0f0';
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#0f0';
                    }
                    
                    ctx.fillRect(segment.x, segment.y, GRID_SIZE, GRID_SIZE);
                    
                    // Draw eyes on head
                    if (segment.isHead) {
                        ctx.fillStyle = '#000';
                        ctx.fillRect(segment.x + 4, segment.y + 4, 3, 3);
                        ctx.fillRect(segment.x + 13, segment.y + 4, 3, 3);
                    }
                }
            }
            ctx.shadowBlur = 0;
        }

        function drawMushrooms() {
            for (const mushroom of mushrooms) {
                ctx.fillStyle = mushroom.color;
                ctx.shadowBlur = mushroom.poisoned ? 15 : 5;
                ctx.shadowColor = mushroom.color;
                
                // Draw mushroom cap
                ctx.beginPath();
                ctx.arc(mushroom.x + GRID_SIZE / 2, mushroom.y + GRID_SIZE / 2, 
                       GRID_SIZE / 2 - mushroom.hits * 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw stem
                ctx.fillStyle = '#fff';
                ctx.fillRect(mushroom.x + GRID_SIZE / 2 - 3, mushroom.y + GRID_SIZE / 2, 6, GRID_SIZE / 2);
                
                // Draw damage indicator
                if (mushroom.hits > 0) {
                    ctx.fillStyle = '#f00';
                    ctx.fillRect(mushroom.x + 2, mushroom.y + 2, 
                               (GRID_SIZE - 4) * (mushroom.hits / mushroom.maxHits), 3);
                }
            }
            ctx.shadowBlur = 0;
        }

        function drawFleas() {
            ctx.fillStyle = '#f0f';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#f0f';
            for (const flea of fleas) {
                ctx.fillRect(flea.x, flea.y, flea.width, flea.height);
                // Draw legs
                ctx.strokeStyle = '#f0f';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(flea.x, flea.y + flea.height / 2);
                ctx.lineTo(flea.x - 4, flea.y + flea.height);
                ctx.moveTo(flea.x + flea.width, flea.y + flea.height / 2);
                ctx.lineTo(flea.x + flea.width + 4, flea.y + flea.height);
                ctx.stroke();
            }
            ctx.shadowBlur = 0;
        }

        function drawSpiders() {
            ctx.fillStyle = '#0ff';
            ctx.shadowBlur = 12;
            ctx.shadowColor = '#0ff';
            for (const spider of spiders) {
                // Draw body
                ctx.beginPath();
                ctx.arc(spider.x + spider.width / 2, spider.y + spider.height / 2, 
                       spider.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw legs
                ctx.strokeStyle = '#0ff';
                ctx.lineWidth = 2;
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.moveTo(spider.x + spider.width / 2, spider.y + spider.height / 2);
                    ctx.lineTo(spider.x + spider.width / 2 + Math.cos(angle) * 12,
                              spider.y + spider.height / 2 + Math.sin(angle) * 12);
                    ctx.stroke();
                }
            }
            ctx.shadowBlur = 0;
        }

        function drawScorpions() {
            ctx.fillStyle = '#ff0';
            ctx.shadowBlur = 12;
            ctx.shadowColor = '#ff0';
            for (const scorpion of scorpions) {
                ctx.fillRect(scorpion.x, scorpion.y, scorpion.width, scorpion.height);
                // Draw tail
                ctx.beginPath();
                ctx.moveTo(scorpion.x + scorpion.width, scorpion.y + scorpion.height / 2);
                ctx.lineTo(scorpion.x + scorpion.width + 8, scorpion.y);
                ctx.lineTo(scorpion.x + scorpion.width + 12, scorpion.y - 4);
                ctx.strokeStyle = '#ff0';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            ctx.shadowBlur = 0;
        }

        function drawParticles() {
            for (const p of particles) {
                const alpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = alpha;
                ctx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
            }
            ctx.globalAlpha = 1;
        }

        function drawGrid() {
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (gameState === 'playing') {
                drawGrid();
                updatePlayer();
                updateBullets();
                updateCentipedes();
                updateMushrooms();
                updateFleas();
                updateSpiders();
                updateScorpions();
                updateParticles();
                checkCollisions();
                checkWaveComplete();
                updateUI();
                
                drawMushrooms();
                drawFleas();
                drawSpiders();
                drawScorpions();
                drawCentipedes();
                drawBullets();
                drawParticles();
                drawPlayer();
            }
            
            frameCount++;
            requestAnimationFrame(gameLoop);
        }

        // Initialize
        gameLoop();
    </script>
</body>
</html>
